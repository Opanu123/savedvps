name: Auto VPS Creator with Backup and Live SSH

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"  # Every 6 hours
  push:
    branches:
      - main

jobs:
  create-vps:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Setup tmate SSH
        run: |
          sudo apt update
          sudo apt install -y tmate
          tmate -S /tmp/tmate.sock new-session -d
          tmate -S /tmp/tmate.sock wait tmate-ready
          tmate -S /tmp/tmate.sock display -p '#{tmate_ssh}' > ssh.txt
          echo "SSH SESSION:"
          cat ssh.txt

      - name: Save SSH to Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ssh
          path: ssh.txt

      - name: Install Python and MEGA Tools
        run: |
          sudo apt install -y python3-pip zip unzip lsof
          pip install mega.py

      - name: Login to MEGA
        run: mega-login "${{ secrets.MEGA_EMAIL }}" "${{ secrets.MEGA_PASSWORD }}"

      - name: Create MEGA folder if not exists
        run: |
          python3 -c "
import subprocess
try:
  folders = subprocess.check_output(['megals']).decode()
  if 'vps-backups' not in folders:
    subprocess.run(['megamkdir', 'vps-backups'])
except Exception as e:
  print('Error creating folder:', e)
          "

      - name: Create Backup (replace with real folder)
        run: |
          mkdir -p minecraft/world
          echo 'Fake World' > minecraft/world/readme.txt
          mkdir -p .backup
          zip -r .backup/autovps.zip minecraft

      - name: Upload Backup to MEGA
        run: megaput .backup/autovps.zip --path vps-backups

      - name: Keep VPS Session Alive
        run: |
          echo "ðŸŸ¢ Session running... Press Ctrl+C to stop"
          while true; do sleep 60; echo "âœ… Alive at $(date)"; done
