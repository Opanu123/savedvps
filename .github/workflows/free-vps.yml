name: Auto VPS Creator with Backup and Live SSH

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"  # Every 6 hours
  push:
    branches:
      - main

jobs:
  create-vps:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Setup tmate SSH
        run: |
          sudo apt update
          sudo apt install -y tmate
          tmate -S /tmp/tmate.sock new-session -d
          tmate -S /tmp/tmate.sock wait tmate-ready
          tmate -S /tmp/tmate.sock display -p '#{tmate_ssh}' > ssh.txt
          echo "SSH SESSION:"
          cat ssh.txt

      - name: Save SSH to Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ssh
          path: ssh.txt

      - name: Install Python & MEGA Tools
        run: |
          sudo apt install -y python3-pip zip unzip
          pip install mega.py

      - name: Login to MEGA
        env:
          MEGA_EMAIL: ${{ secrets.MEGA_EMAIL }}
          MEGA_PASSWORD: ${{ secrets.MEGA_PASSWORD }}
        run: mega-login "$MEGA_EMAIL" "$MEGA_PASSWORD"

      - name: Ensure MEGA backup folder exists
        run: |
          if ! megals | grep -q "vps-backups"; then
            megamkdir vps-backups
          fi

      - name: Create a Minecraft Backup (replace this with your real folder)
        run: |
          mkdir -p minecraft/world
          echo "Fake World" > minecraft/world/readme.txt
          mkdir -p .backup
          zip -r .backup/autovps.zip minecraft

      - name: Upload Backup to MEGA
        run: |
          megaput .backup/autovps.zip --path vps-backups

      - name: Keep Session Alive
        run: |
          echo "✅ Session running... press Ctrl+C to stop"
          while true; do sleep 60; echo "🔁 Still alive at $(date)"; done
