name: Auto VPS All-in-One

on:
  workflow_dispatch:
  push:
    branches: [main]
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours

jobs:
  auto-vps:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: ‚¨áÔ∏è Checkout
        uses: actions/checkout@v3

      - name: üìÅ Create dirs
        run: mkdir -p links .backup

      - name: üîê Start tmate session
        run: |
          echo "‚öôÔ∏è Launching tmate..."
          sudo apt update && sudo apt install -y tmate
          tmate -S /tmp/tmate.sock new-session -d
          tmate -S /tmp/tmate.sock wait tmate-ready
          SSH=$(tmate -S /tmp/tmate.sock display -p '#{tmate_ssh}')
          echo "$SSH" > "links/autovps.txt"
          echo "‚úÖ SSH Ready: $SSH"

      - name: üì¶ Save backup locally
        run: |
          zip -r ".backup/autovps.zip" . -x ".git/*" ".github/*" ".backup/*" || true

      - name: üì§ Push SSH + backup to repo
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "üîÅ Updated SSH and backup (auto)"
          file_pattern: 'links/*.txt .backup/*.zip'

      - name: üì¶ Install MEGA Tools
        run: |
          sudo apt update
          sudo apt install -y megatools

      - name: üîê MEGA Login
        run: |
          echo "[Login]" > ~/.megarc
          echo "Username = ${{ secrets.MEGA_EMAIL }}" >> ~/.megarc
          echo "Password = ${{ secrets.MEGA_PASSWORD }}" >> ~/.megarc
          chmod 600 ~/.megarc

      - name: ‚òÅÔ∏è Check MEGA login and upload backup
        run: |
          if megals --reload 2>&1 | grep -q 'failed'; then
            echo "‚ö†Ô∏è MEGA login failed, skipping upload"
            exit 0
          fi
          megaput .backup/autovps.zip --path /vps-backups/

      - name: ‚è≥ Keep session alive
        run: |
          echo "‚è≥ Keeping session alive for 6 hours..."
          sleep 21600
