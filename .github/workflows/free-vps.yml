name: Auto VPS Creator with Backup and Live SSH

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"
  push:
    branches:
      - main

jobs:
  create-vps:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Setup tmate SSH
        run: |
          sudo apt update
          sudo apt install -y tmate
          tmate -S /tmp/tmate.sock new-session -d
          tmate -S /tmp/tmate.sock wait tmate-ready
          tmate -S /tmp/tmate.sock display -p '#{tmate_ssh}' > ssh.txt
          echo "SSH SESSION:"
          cat ssh.txt

      - name: Save SSH to Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ssh
          path: ssh.txt

      - name: Install MEGAcmd
        run: |
          sudo apt update
          sudo apt install -y wget gnupg
          wget -qO - https://mega.nz/keys/MEGA_signing.key | sudo apt-key add -
          echo "deb https://mega.nz/linux/MEGAsync/xUbuntu_20.04/ ./" | sudo tee /etc/apt/sources.list.d/mega.list
          sudo apt update
          sudo apt install -y megacmd

      - name: Login to MEGA
        env:
          MEGA_EMAIL: ${{ secrets.MEGA_EMAIL }}
          MEGA_PASSWORD: ${{ secrets.MEGA_PASSWORD }}
        run: mega-login "$MEGA_EMAIL" "$MEGA_PASSWORD"

      - name: Ensure MEGA folder exists
        run: |
          if ! megals | grep -q "vps-backups"; then
            megamkdir vps-backups
          fi

      - name: Create Minecraft backup
        run: |
          mkdir -p minecraft/world
          echo "Fake World" > minecraft/world/readme.txt
          mkdir -p .backup
          zip -r .backup/autovps.zip minecraft

      - name: Upload to MEGA
        run: |
          megaput .backup/autovps.zip --path vps-backups

      - name: Keep VPS Session Alive
        run: |
          echo "ðŸŸ¢ VPS Session Alive"
          while true; do sleep 60; echo "âœ… $(date)"; done
